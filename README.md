# Reporting Service

Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ TSV Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ², ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² PostgreSQL, Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ PDF Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ² Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ API Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹.

## ğŸ“‹ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

- **ĞĞ²Ñ‚Ğ¾ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** Ğ¿Ğ°Ğ¿ĞºĞ¸ `input/` (Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ)
- **ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ TSV** Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²
- **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ** Ğ² PostgreSQL
- **Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF** Ğ¾Ñ‚Ñ‡ĞµÑ‚Ğ¾Ğ² Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°
- **ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸** Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°Ğ¼Ğ¸
- **REST API** Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- **Docker** ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- **Graceful shutdown**

## ğŸš€ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚

### 1. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Docker Compose
```bash
docker-compose up --build
```

### 2. Ğ’ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğµ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ² input
```bash
cp input_test/data.tsv input/
```

### 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ
```bash
# API Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
curl "http://localhost:8080/api/v1/devices/01749246-960c-5832-b2aa-ed2b4da5e137?page=1&limit=5"

# PDF Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ Ğ¿Ğ¾ÑĞ²ÑÑ‚ÑÑ Ğ² output/
ls -la output/
```

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

**1. ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ¸ PostgreSQL:**
```bash
docker-compose up -d
```

**2. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ‘Ğ” Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°:**
```bash
docker-compose logs postgres | grep "ready"
```

**3. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸ Ñ‚ĞµÑÑ‚:**
```bash
go test -v ./internal/test
```

**4. ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸ Ğ‘Ğ”:**
```bash
docker-compose down
```

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**
```
--- PASS: TestIntegration
--- PASS: TestParserIntegration
PASS
```

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
.
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ main.go                    # Ğ¢Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°, Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ²ÑĞµÑ… ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²
â”‚
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.go                 # Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
â”‚   â”‚   â”œâ”€â”€ helper.go                 # Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ñ‹
â”‚   â”‚   â””â”€â”€ loader.go                # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ° (viper)
â”‚   â”‚
â”‚   â”œâ”€â”€ logger/
â”‚   â”‚   â””â”€â”€ logger.go                # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° slog Ğ»Ğ¾Ğ³Ğ³ĞµÑ€Ğ°
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ models.go               # Domain Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸: DeviceMessage, ProcessedFile
â”‚   â”‚
â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â””â”€â”€ parser.go              # ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ TSV â†’ []DeviceMessage
â”‚   â”‚
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â””â”€â”€ postgres/
â”‚   â”‚       â”œâ”€â”€ database.go        # ĞŸÑƒĞ» ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹ + goose Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
â”‚   â”‚       â””â”€â”€ repo.go           # Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ² Ñ squirrel
â”‚   â”‚
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ scanner.go            # Ğ¡ĞºĞ°Ğ½ĞµÑ€ Ğ¿Ğ°Ğ¿ĞºĞ¸, Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ, Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹, PDF
â”‚   â”‚   â””â”€â”€ service.go           # DeviceService Ğ´Ğ»Ñ API
â”‚   â”‚
â”‚   â””â”€â”€ transport/
â”‚       â”œâ”€â”€ handler/
â”‚       â”‚   â””â”€â”€ device.go        # HTTP Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€ GET /api/v1/devices/{id}
â”‚       â”œâ”€â”€ router/
â”‚       â”‚   â””â”€â”€ router.go        # ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ chi
â”‚       â””â”€â”€ server/
â”‚           â””â”€â”€ server.go        # HTTP ÑĞµÑ€Ğ²ĞµÑ€ Ñ graceful shutdown
â”‚
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ postgres/
â”‚       â”œâ”€â”€ 001_create_processed_files_table.go  # processed_files
â”‚       â””â”€â”€ 002_create_device_messages_table.go  # device_messages
â”‚
â”œâ”€â”€ fonts/                         # TrueType ÑˆÑ€Ğ¸Ñ„Ñ‚Ñ‹ Ğ´Ğ»Ñ PDF (DejaVu)
â”œâ”€â”€ input/                        # Ğ¡ÑĞ´Ğ° ĞºĞ»Ğ°Ğ´ĞµÑˆÑŒ TSV Ñ„Ğ°Ğ¹Ğ»Ñ‹ (Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ)
â”œâ”€â”€ output/                       # Ğ—Ğ´ĞµÑÑŒ Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‚ÑÑ PDF Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹ (Ğ¼Ğ¾Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ)
â”œâ”€â”€ input_test/                  # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ TSV Ñ„Ğ°Ğ¹Ğ»
â”‚   â””â”€â”€ data.tsv
â”‚
â”œâ”€â”€ config.yaml                  # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
â”œâ”€â”€ docker-compose.yml          # postgres + app
â”œâ”€â”€ Dockerfile                 # ĞœĞ½Ğ¾Ğ³Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½Ñ‡Ğ°Ñ‚Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ README.md
```

## ğŸ”§ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (config.yaml)

```yaml
database:
  host: postgres
  port: 5432
  user: postgres
  password: postgres
  name: reporting-service
  ssl_mode: disable

server:
  port: 8080
  read_timeout: "5s"
  write_timeout: "10s"
  idle_timeout: "10s"

logger:
  level: "info"
  json: false

migrations:
  dir: "migrations/postgres"

application:
  input_dir: "input"
  output_dir: "output"
  scan_period: "30s"
  queue_size: 100
  workers: 3
  max_retries: 3
```

## ğŸ“„ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ TSV Ñ„Ğ°Ğ¹Ğ»Ğ°

ĞŸĞµÑ€Ğ²Ñ‹Ğµ 2 ÑÑ‚Ñ€Ğ¾ĞºĞ¸ â€” Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸, Ñ 3-Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:

```tsv
#Ğ½Ğ¾Ğ¼ĞµÑ€	mqtt	Ğ¸Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€Ğ½Ñ‹Ğ¹	Ğ³ÑƒĞ¸Ğ´	id ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ	Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ	ÑÑ€ĞµĞ´Ğ°	ĞºĞ»Ğ°ÑÑÑ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ	ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ	Ğ—Ğ¾Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…	Ğ°Ğ´Ñ€ĞµÑ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğ¹
n 	mqtt	invid   	unit_guid	msg_id         	text       	context	class  	level	area 	addr
1 	    	G-044322	01749246-95f6-57db-b7c3-2ae0e8be671f	cold7_Defrost_status     	Ğ Ğ°Ğ·Ğ¼Ğ¾Ñ€Ğ¾Ğ·ĞºĞ°     	waiting	100  	LOCAL	cold7_status.Defrost_status
```

## ğŸ”„ Workflow ÑĞµÑ€Ğ²Ğ¸ÑĞ°

1. **Ğ¡ĞºĞ°Ğ½ĞµÑ€** Ğ¿Ğ¾ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€Ñƒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¿Ğ°Ğ¿ĞºÑƒ `input/`
2. **ĞĞ¾Ğ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹** â†’ Ğ±ÑƒÑ„ĞµÑ€Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ½Ğ°Ğ» (Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ)
3. **Ğ’Ğ¾Ñ€ĞºĞµÑ€Ñ‹** Ğ·Ğ°Ğ±Ğ¸Ñ€Ğ°ÑÑ‚ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
4. **ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³** TSV â†’ []DeviceMessage
5. **Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ** Ğ² PostgreSQL (batch insert)
6. **Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ PDF** Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ unit_guid
7. **ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°** Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ² processed_files
8. **API** Ğ¾Ñ‚Ğ´Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ‘Ğ” Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹
```
